<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Helados Mari</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: sans-serif; background: #f0f2f5; margin: 0; padding-bottom: 50px; }
        header { background: #0044cc; color: white; text-align: center; padding: 15px; font-weight: bold; border-bottom: 4px solid #ffcc00; }
        nav { display: flex; justify-content: space-around; background: white; padding: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        nav button { border: none; background: none; font-weight: bold; color: #555; cursor: pointer; padding: 10px; }
        .active { color: #0044cc; border-bottom: 2px solid #0044cc; }
        .container { padding: 20px; max-width: 500px; margin: auto; }
        .card { background: white; padding: 15px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 15px; }
        input, select { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; font-size: 16px; }
        .btn { width: 100%; padding: 15px; border: none; border-radius: 5px; color: white; font-weight: bold; cursor: pointer; }
        .fila { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #eee; }
    </style>
</head>
<body>

<header>üç¶ HELADOS MARI</header>

<nav>
    <button onclick="ver('v')" id="nv" class="active">Venta</button>
    <button onclick="ver('d')" id="nd">Deudas</button>
    <button onclick="ver('a')" id="na">Admin</button>
</nav>

<div class="container">
    <div id="pv">
        <div class="card">
            <input type="text" id="cli" placeholder="Nombre Cliente">
            <select id="pro"></select>
            <button class="btn" style="background:#28a745" onclick="reg('Pagado')">PAGADO</button>
            <button class="btn" style="background:#dc3545; margin-top:10px" onclick="reg('Cr√©dito')">DEUDA</button>
        </div>
    </div>

    <div id="pd" style="display:none">
        <div class="card" style="text-align:center">
            <p>POR COBRAR</p>
            <h1 id="tot" style="color:#dc3545">$0.00</h1>
        </div>
        <div id="lista-d" class="card"></div>
    </div>

    <div id="pa" style="display:none">
        <div class="card">
            <input type="text" id="an" placeholder="Nuevo Helado">
            <input type="number" id="ap" placeholder="Precio">
            <button class="btn" style="background:#0044cc" onclick="crear()">Guardar</button>
        </div>
        <div id="lista-a"></div>
    </div>
</div>

<script>
    const URL = "https://bohwyjtmyrtzuiyfqeto.supabase.co";
    const KEY = "sb_publishable_VYeyhaK2liOkgm8P3m8uyA_Bpkj1ZsF";
    const sb = supabase.createClient(URL, KEY);

    function ver(t) {
        document.getElementById('pv').style.display = t=='v'?'block':'none';
        document.getElementById('pd').style.display = t=='d'?'block':'none';
        document.getElementById('pa').style.display = t=='a'?'block':'none';
        if(t=='d') mD(); if(t=='a') mA();
    }

    async function mI() {
        const {data} = await sb.from('productos').select('*').order('nombre');
        const s = document.getElementById('pro');
        if(data) s.innerHTML = data.map(p => `<option value="${p.id}" data-p="${p.precio}">${p.nombre} ($${p.precio})</option>`).join('');
    }

    async function reg(e) {
        const n = document.getElementById('cli').value;
        const s = document.getElementById('pro');
        if(!n) return alert("Nombre faltante");
        let {data:c} = await sb.from('clientes').select('id').eq('nombre', n).maybeSingle();
        if(!c) { const {data:nc} = await sb.from('clientes').insert([{nombre:n}]).select().single(); c=nc; }
        await sb.from('ventas').insert([{cliente_id:c.id, producto_id:s.value, total:s.options[s.selectedIndex].dataset.p, estado:e}]);
        alert("Guardado"); document.getElementById('cli').value="";
    }

    async function mD() {
        const {data} = await sb.from('ventas').select('total, clientes(nombre)').eq('estado', 'Cr√©dito');
        const l = document.getElementById('lista-d');
        let t = 0; l.innerHTML = "";
        const res = {};
        if(data) {
            data.forEach(v => {
                const n = v.clientes ? v.clientes.nombre : "Sin nombre";
                res[n] = (res[n] || 0) + parseFloat(v.total);
                t += parseFloat(v.total);
            });
            for(const k in res) {
                l.innerHTML += `<div class="fila"><span>${k}</span><b>$${res[k].toFixed(2)}</b></div>`;
            }
        }
        document.getElementById('tot').innerText = "$"+t.toFixed(2);
    }

    async function mA() {
        const {data} = await sb.from('productos').select('*').order('nombre');
        const l = document.getElementById('lista-a');
        if(data) l.innerHTML = data.map(p => `<div class="card fila"><span>${p.nombre}</span><b>$${p.precio}</b></div>`).join('');
    }

    async function crear() {
        const n = document.getElementById('an').value;
        const p = document.getElementById('ap').value;
        if(n && p) { await sb.from('productos').insert([{nombre:n, precio:p}]); mI(); mA(); }
    }

    window.onload = mI;
</script>
</body>
</html>
