<div id="venta" class="tab-content active">
    <div class="card">
        <h3>Nueva Venta</h3>
        
        <label>Nombre del Cliente</label>
        <input type="text" id="v-cliente" list="lista-clientes" placeholder="Escribe o selecciona un cliente">
        <datalist id="lista-clientes"></datalist> <label>Producto</label>
        <select id="v-producto"></select>
        
        <button class="btn btn-pay" onclick="agregarAlCarrito()" style="margin-top: 10px; background: var(--blue);">+ Agregar al Carrito</button>

        <div id="carrito-seccion" style="margin-top: 20px; border-top: 1px solid #ddd; padding-top: 10px; display: none;">
            <h4>Productos a vender:</h4>
            <div id="lista-carrito"></div>
            <div style="text-align: right; font-weight: bold; margin: 10px 0;">Total: $<span id="total-carrito">0.00</span></div>
            
            <div class="btn-group">
                <button class="btn btn-pay" onclick="finalizarVenta('Pagado')">‚úÖ PAGADO</button>
                <button class="btn btn-credit" onclick="finalizarVenta('Cr√©dito')">üî¥ CR√âDITO</button>
            </div>
        </div>
    </div>
</div>

<script>
// --- NUEVAS VARIABLES Y FUNCIONES PARA VENTA FLEXIBLE ---
let carrito = [];

// 1. Cargar sugerencias de clientes (Autocompletado)
async function cargarSugerenciasClientes() {
    const { data } = await supabase.from('clientes').select('nombre');
    const datalist = document.getElementById('lista-clientes');
    datalist.innerHTML = '';
    // Eliminar duplicados si existen
    const nombresUnicos = [...new Set(data.map(c => c.nombre))];
    nombresUnicos.forEach(nombre => {
        const option = document.createElement('option');
        option.value = nombre;
        datalist.appendChild(option);
    });
}

// 2. Agregar producto al carrito local
function agregarAlCarrito() {
    const select = document.getElementById('v-producto');
    const productoId = select.value;
    const textoProducto = select.options[select.selectedIndex].text;
    const precio = parseFloat(textoProducto.match(/\$(\d+\.?\base2d*)/)[1]);
    const nombreProd = textoProducto.split(' (')[0];

    if (!productoId) return;

    carrito.push({ id: productoId, nombre: nombreProd, precio: precio });
    actualizarVistaCarrito();
}

// 3. Quitar producto si hubo error
function quitarDelCarrito(index) {
    carrito.splice(index, 1);
    actualizarVistaCarrito();
}

function actualizarVistaCarrito() {
    const lista = document.getElementById('lista-carrito');
    const seccion = document.getElementById('carrito-seccion');
    const totalSpan = document.getElementById('total-carrito');
    
    if (carrito.length === 0) {
        seccion.style.display = 'none';
        return;
    }

    seccion.style.display = 'block';
    lista.innerHTML = '';
    let total = 0;

    carrito.forEach((item, index) => {
        total += item.precio;
        lista.innerHTML += `
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; background: #f9f9f9; padding: 5px; border-radius: 4px;">
                <span>${item.nombre} - $${item.precio.toFixed(2)}</span>
                <button onclick="quitarDelCarrito(${index})" style="background:none; border:none; color:red; cursor:pointer;">üóëÔ∏è</button>
            </div>`;
    });
    totalSpan.innerText = total.toFixed(2);
}

// 4. Finalizar la venta de todo el carrito
async function finalizarVenta(estado) {
    const clienteNom = document.getElementById('v-cliente').value;
    if (!clienteNom || carrito.length === 0) {
        alert("Falta el nombre del cliente o productos en el carrito");
        return;
    }

    // Buscar o crear cliente
    let { data: cliente } = await supabase.from('clientes').select('*').eq('nombre', clienteNom).single();
    if (!cliente) {
        const { data: nuevo } = await supabase.from('clientes').insert([{ nombre: clienteNom }]).select().single();
        cliente = nuevo;
    }

    // Registrar cada producto del carrito
    for (const item of carrito) {
        await supabase.from('ventas').insert([{
            cliente_id: cliente.id,
            producto_id: item.id,
            cantidad: 1,
            total: item.precio,
            estado: estado
        }]);
    }

    alert(`Venta registrada como: ${estado}`);
    carrito = [];
    document.getElementById('v-cliente').value = '';
    actualizarVistaCarrito();
    cargarSugerenciasClientes(); // Actualizar lista de autocompletado
}

// Aseg√∫rate de llamar a cargarSugerenciasClientes() cuando cargue la p√°gina
window.onload = function() {
    cargarProductos();
    cargarSugerenciasClientes();
};
</script>
